<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Cocina | RestoFlow</title>
    <link rel="stylesheet" href="styleCocina.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>üë®‚Äçüç≥ Comandas Recibidas</h1>
    <div id="kitchenDisplay" class="kitchen-grid"></div>

    <script>
        const socket = io();
        let lastOrderCount = 0;

        function getTimerData(timestampEntrada) {
            const transcurrido = Date.now() - parseInt(timestampEntrada);
            const restante = (15 * 60 * 1000) - transcurrido;
            const minutos = Math.floor(Math.abs(restante) / 60000);
            const segundos = Math.floor((Math.abs(restante) % 60000) / 1000);
            const tiempo = `${minutos}:${segundos < 10 ? '0' : ''}${segundos}`;

            let color = "timer-black";
            if (restante > 600000) color = "timer-green";
            else if (restante > 300000) color = "timer-yellow";
            else if (restante > 0) color = "timer-red";

            return { tiempo, color, prefijo: restante < 0 ? "RETRASO: +" : "" };
        }

        function renderKitchen(queue) {
            const display = document.getElementById('kitchenDisplay');
            display.innerHTML = '';

            queue.forEach((ticket, index) => {
                const timer = getTimerData(ticket.timestamp);
                const itemsHtml = ticket.items.map(item => `
                    <div style="border-bottom: 1px solid rgba(0,0,0,0.1); padding: 5px 0;">
                        <strong>[ ${item.quantity} ] ${item.name}</strong>
                        <div style="font-size: 0.85em; color: #555; font-style: italic;">
                            ${item.details ? '‚Ü≥ ' + item.details : ''}
                        </div>
                    </div>`).join('');

                display.innerHTML += `
                    <div class="ticket ${timer.color}">
                        <span>Llegada: ${ticket.time}</span>
                        <h3>${ticket.table}</h3>
                        <div class="timer-display">${timer.prefijo}${timer.tiempo}</div>
                        <div class="items-list">${itemsHtml}</div>
                        <button class="btn-done" onclick="removeTicket(${index})">‚úÖ LISTO</button>
                    </div>`;
            });
        }

        function anunciarPedido() {
            const mensaje = new SpeechSynthesisUtterance("Orden de men√∫ Zenilda");
            mensaje.lang = 'es-ES';
            window.speechSynthesis.speak(mensaje);
        }

        function removeTicket(index) {
            socket.emit('pedido-listo', index); // Avisa al servidor para borrarlo en todos los celus
        }

        // ESCUCHAR AL SERVIDOR
        socket.on('actualizar-cocina', (queue) => {
            if (queue.length > lastOrderCount) anunciarPedido();
            lastOrderCount = queue.length;
            renderKitchen(queue);
        });

        socket.on('cargar-pedidos', (queue) => {
            lastOrderCount = queue.length;
            renderKitchen(queue);
        });

        // Refrescar los relojes cada segundo
        setInterval(() => {
            socket.emit('solicitar-actualizacion'); // Opcional: para sincronizar tiempo
        }, 1000);
    </script>
</body>
</html>